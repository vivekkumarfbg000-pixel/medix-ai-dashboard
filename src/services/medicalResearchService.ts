import logger from \"@/utils/logger\";\n\nconst PUBMED_API = \"https://eutils.ncbi.nlm.nih.gov/entrez/eutils\";\nconst FDA_API = \"https://api.fda.gov/drug/label.json\";\n\ninterface PubMedArticle {\n  title: string;\n  pubdate: string;\n  pmid: string;\n  source: string;\n}\n\ninterface FDAData {\n  warnings: string[];\n  indications: string;\n  source: string;\n}\n\ninterface SynthesizedAnswer {\n  answer: string;\n  citations: string[];\n}\n\n// Import callGroqAI dynamically to avoid circular dependency\nconst callGroqAI = async (messages: any[], model: string, jsonMode: boolean): Promise<string> => {\n  const { aiService } = await import(\"./aiService\");\n  // Use aiService chatWithAgent as a proxy\n  const result = await aiService.chatWithAgent(JSON.stringify({ messages, model, jsonMode }));\n  return result.reply;\n};\n\nconst safeJSONParse = (text: string, fallback: any = null): any => {\n  try {\n    // Remove markdown code blocks if present\n    let cleaned = text.replace(/```json\\s*|```\\s*/g, \"\").trim();\n    return JSON.parse(cleaned);\n  } catch (e) {\n    logger.warn(\"JSON parse failed\", e);\n    return fallback;\n  }\n};\n\nexport const medicalResearchService = {\n  /**\n   * Search PubMed for peer-reviewed medical research\n   */\n  async searchPubMed(query: string, maxResults = 3): Promise<PubMedArticle[]> {\n    try {\n      // Step 1: Search for article IDs\n      const searchUrl = `${PUBMED_API}/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmode=json&retmax=${maxResults}&sort=relevance&reldate=1825`; // Last 5 years\n      const response = await fetch(searchUrl);\n      const data = await response.json();\n      const ids = data.esearchresult?.idlist || [];\n\n      if (ids.length === 0) return [];\n\n      // Step 2: Fetch article details\n      const summaryUrl = `${PUBMED_API}/esummary.fcgi?db=pubmed&id=${ids.join(\",\")}&retmode=json`;\n      const summaryResponse = await fetch(summaryUrl);\n      const summaryData = await summaryResponse.json();\n\n      return ids.map((id: string) => ({\n        title: summaryData.result?.[id]?.title || \"No title\",\n        pubdate: summaryData.result?.[id]?.pubdate || \"\",\n        pmid: id,\n        source: `https://pubmed.ncbi.nlm.nih.gov/${id}/`,\n      }));\n    } catch (error) {\n      logger.error(\"PubMed API error:\", error);\n      return [];\n    }\n  },\n\n  /**\n   * Check FDA OpenData for drug safety information\n   */\n  async checkFDA(drugName: string): Promise<FDAData | null> {\n    try {\n      const searchQuery = encodeURIComponent(`openfda.brand_name:\"${drugName}\" OR openfda.generic_name:\"${drugName}\"`);\n      const response = await fetch(`${FDA_API}?search=${searchQuery}&limit=1`);\n      const data = await response.json();\n      const result = data.results?.[0];\n\n      if (result) {\n        return {\n          warnings: result.warnings || result.boxed_warning || [],\n          indications:\n            Array.isArray(result.indications_and_usage)\n              ? result.indications_and_usage[0]\n              : result.indications_and_usage || \"\",\n          source: \"FDA OpenData\",\n        };\n      }\n      return null;\n    } catch (error) {\n      logger.error(\"FDA API error:\", error);\n      return null;\n    }\n  },\n\n  /**\n   * Synthesize answer from multiple research sources\n   * Note: Uses simple formatting instead of Groq AI to avoid circular dependency\n   */\n  async synthesizeAnswer(query: string, sources: any): Promise<SynthesizedAnswer> {\n    try {\n      const { pubmed, fda } = sources;\n      let answer = \"\";\n      const citations: string[] = [];\n\n      // Build answer from sources\n      if (fda) {\n        answer += `Based on FDA data:\\n`;\n        if (fda.indications) {\n          answer += `Indications: ${fda.indications.substring(0, 200)}...\\n\\n`;\n        }\n        if (fda.warnings && fda.warnings.length > 0) {\n          answer += `⚠️ Warnings: ${fda.warnings[0].substring(0, 200)}...\\n\\n`;\n        }\n        citations.push(\"FDA: OpenFDA Drug Database\");\n      }\n\n      if (pubmed && pubmed.length > 0) {\n        answer += `Recent research findings:\\n`;\n        pubmed.slice(0, 2).forEach((article: PubMedArticle) => {\n          answer += `• ${article.title.substring(0, 100)}...\\n`;\n          citations.push(`PubMed: ${article.title.substring(0, 50)}... (${article.pubdate}) PMID: ${article.pmid}`);\n        });\n      }\n\n      if (!answer) {\n        return {\n          answer: \"No authoritative medical information found. Please consult medical databases directly or seek professional medical advice.\",\n          citations: [],\n        };\n      }\n\n      answer += \"\\n⚠️ Important: This information is for reference only. Always consult a healthcare professional for medical advice.\";\n\n      return { answer, citations };\n    } catch (error) {\n      logger.error(\"Answer synthesis error:\", error);\n      return {\n        answer: \"Unable to generate answer. Please consult medical sources directly.\",\n        citations: [],\n      };\n    }\n  },\n\n  /**\n   * Main entry point: Search medical research and provide answer\n   */\n  async searchMedicalResearch(query: string): Promise<SynthesizedAnswer> {\n    logger.log(\"[Medical Research] Searching for:\", query);\n\n    // Extract drug name if present (simple regex)\n    const drugMatch = query.match(\n      /\\b([A-Z][a-z]+(?:zole|pam|pril|sartan|statin|mycin|cillin|floxacin|tadine|morphine|codeine|phylline)?|metformin|aspirin|ibuprofen|paracetamol|acetaminophen|dolo|azithromycin|amoxicillin|ciprofloxacin)\\b/i\n    );\n    const drugName = drugMatch ? drugMatch[1] : null;\n\n    // Parallel search\n    const [pubmedResults, fdaData] = await Promise.all([\n      this.searchPubMed(query),\n      drugName ? this.checkFDA(drugName) : Promise.resolve(null),\n    ]);\n\n    logger.log(\"[Medical Research] Results:\", { pubmed: pubmedResults.length, fda: !!fdaData });\n\n    // If no sources found, return early\n    if (pubmedResults.length === 0 && !fdaData) {\n      return {\n        answer:\n          \"No authoritative medical research found for this query. Please consult medical databases directly or seek professional medical advice.\",\n        citations: [],\n      };\n    }\n\n    // Synthesize answer with citations\n    return await this.synthesizeAnswer(query, {\n      pubmed: pubmedResults,\n      fda: fdaData,\n    });\n  },\n};\n
